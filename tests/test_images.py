from unittest import mock
import base64
from rest_framework.test import APIRequestFactory
from django.core.files.uploadedfile import SimpleUploadedFile

from api.users.factories import UserFactory
from api.images.views import ImageAssetUploadView
from api.images.service import create_image_file_from_data_uri


@mock.patch("api.images.views.create_image_asset")
def test_image_upload(create_image_asset, auth_client):
    # TODO can this be improved?
    url = "/images/upload/"
    tmp_file = SimpleUploadedFile(
        "file.jpg", b"file_content", content_type="image/jpge"
    )
    factory = APIRequestFactory()
    request = factory.put(url, data={"file": tmp_file}, content_type="image/jpeg",)
    request.user = UserFactory()
    put_view = ImageAssetUploadView().as_view()
    resp = put_view(request, filename="test.png")

    assert create_image_asset.called
    assert resp.status_code == 201
    assert resp.data


def test_image_from_data_uri():
    data_uri = """data:image/png;base64,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"""
    img_file = create_image_file_from_data_uri(data_uri)
    assert img_file.file
    assert base64.b64encode(img_file.file.getvalue()).decode() in data_uri
